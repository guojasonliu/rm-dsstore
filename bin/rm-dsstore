#!/usr/bin/env bash

show_help() {
	cat <<EOF
rm-dsstore â€” recursively delete macOS .DS_Store files

Usage: rm-dsstore [OPTIONS] [PATH ...]

If no PATH is given, defaults to current directory.

Options:
	-n, --dry-run   Show what would be deleted; don't delete
	-v, --verbose   Print progress
	-h, --help      Show this help and exit


Examples:
	rm-dsstore                # current directory
	rm-dsstore ~/Projects     # specific tree
	rm-dsstore -n -v . ~/code # dry-run multiple paths
EOF
}


DRY_RUN=0
VERBOSE=0
PATHS=()


while (( "$#" )); do
	case "$1" in
		-n|--dry-run) DRY_RUN=1; shift ;;
		-v|--verbose) VERBOSE=1; shift ;;
		-h|--help) show_help; exit 0 ;;
		--) shift; break ;;
		-*) echo "Unknown option: $1" >&2; exit 2 ;;
		*) PATHS+=("$1"); shift ;;
	esac
done


# Append any leftover positional args after --
for arg in "$@"; do
	PATHS+=("$arg")
done


if [ ${#PATHS[@]} -eq 0 ]; then
	PATHS=(".")
fi


found_any=0
for p in "${PATHS[@]}"; do
	if [ ! -e "$p" ]; then
		echo "rm-dsstore: path not found: $p" >&2
		continue
	fi

	(( VERBOSE )) && echo "Scanning: $p"

	if (( DRY_RUN )); then
		# Print candidates; don't delete
		if out=$(find "$p" -type f -name '.DS_Store' -print); then
			if [ -n "$out" ]; then
				found_any=1
				echo "$out"
			fi
		fi
	else
		# Delete and optionally show each path
		if (( VERBOSE )); then
			# Print then delete
			while IFS= read -r f; do
				echo "Deleting: $f"
			done < <(find "$p" -type f -name '.DS_Store' -print)
		fi

		# Actual deletion
		find "$p" -type f -name '.DS_Store' -delete
	fi
done


if (( DRY_RUN )); then
	if (( found_any )); then
		echo "(dry-run) Above files would be deleted."
	else
		echo "(dry-run) No .DS_Store files found."
	fi
fi